#!/usr/bin/env python3
import configparser
import pathlib
import subprocess

conf_file = pathlib.Path.home() / ".config" / "manual-install.ini"

config = configparser.ConfigParser()
config.read(conf_file)

print("Upgrading manually installed software")
for name, section in config.items():
    if name == "DEFAULT":
        continue

    print(f"\nChecking {name}...")
    if all([v in section for v in ("installed", "last")]):
        installed = subprocess.run(
            section.get("installed"), shell=True, capture_output=True, text=True
        ).stdout.strip()
        last = subprocess.run(
            section.get("last"), shell=True, capture_output=True, text=True
        ).stdout.strip()
        updated = last == installed
        if updated:
            print(f"Already up to date (version: '{installed}')")
    else:
        updated = False

    if not updated:
        print("Installing latest version...")
        subprocess.run(section.get("install"), shell=True)
        print(f"{name} installed.")
